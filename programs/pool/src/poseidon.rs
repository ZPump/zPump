use ark_bn254::Fr;
use ark_ff::{BigInteger256, Field, Zero};

const MERKLE_DEPTH: usize = 32;
const _: [(); MERKLE_DEPTH] = [(); ptf_common::MERKLE_DEPTH as usize];

const WIDTH: usize = 3;
const FULL_ROUNDS: usize = 8;
const PARTIAL_ROUNDS: usize = 57;

const fn fr(limbs: [u64; 4]) -> Fr {
    Fr::new(BigInteger256::new(limbs))
}

#[inline(always)]
pub fn hash_two(left: &Fr, right: &Fr) -> Fr {
    let mut state = [Fr::zero(), *left, *right];
    apply_permutation(&mut state);
    state[0]
}

#[inline(always)]
pub fn merkle_zero(level: usize) -> Fr {
    debug_assert!(level < MERKLE_DEPTH);
    MERKLE_ZEROES[level]
}

fn apply_permutation(state: &mut [Fr; WIDTH]) {
    let mut round = 0usize;

    for _ in 0..(FULL_ROUNDS / 2) {
        add_round_constants(state, round);
        apply_full_sbox(state);
        apply_mds(state);
        round += 1;
    }

    for _ in 0..PARTIAL_ROUNDS {
        add_round_constants(state, round);
        apply_partial_sbox(state);
        apply_mds(state);
        round += 1;
    }

    for _ in 0..(FULL_ROUNDS / 2) {
        add_round_constants(state, round);
        apply_full_sbox(state);
        apply_mds(state);
        round += 1;
    }
}

fn add_round_constants(state: &mut [Fr; WIDTH], round: usize) {
    for i in 0..WIDTH {
        state[i] += POSEIDON_ARC[round * WIDTH + i];
    }
}

fn apply_full_sbox(state: &mut [Fr; WIDTH]) {
    for elem in state.iter_mut() {
        quintic_pow_in_place(elem);
    }
}

fn apply_partial_sbox(state: &mut [Fr; WIDTH]) {
    quintic_pow_in_place(&mut state[0]);
}

fn apply_mds(state: &mut [Fr; WIDTH]) {
    let mut next = [Fr::zero(); WIDTH];
    for (row_index, row) in POSEIDON_MDS.iter().enumerate() {
        let mut acc = Fr::zero();
        for (coeff, value) in row.iter().zip(state.iter()) {
            acc += *coeff * value;
        }
        next[row_index] = acc;
    }
    *state = next;
}

#[inline(always)]
fn quintic_pow_in_place(value: &mut Fr) {
    let mut sq = *value;
    sq.square_in_place();
    let mut quad = sq;
    quad.square_in_place();
    *value *= quad;
}

include!("poseidon_consts.in");

const MERKLE_ZEROES: [Fr; MERKLE_DEPTH] = [
    fr([
        12121982123933845604,
        15866503461060138275,
        4389536233047581825,
        2348897666712444587,
    ]),
    fr([
        7468225217650880993,
        2745582564151823856,
        16082383337502844908,
        1182589892303069795,
    ]),
    fr([
        2942397237618463288,
        5079056432414268885,
        3331948549133246726,
        1798118438174909103,
    ]),
    fr([
        14604214085630072106,
        17417434438447825509,
        7142990386202747717,
        574728161608577235,
    ]),
    fr([
        8889239344713842517,
        12004843489313598797,
        14511476837172062471,
        3140362845087511541,
    ]),
    fr([
        2094698994635677048,
        18363179443317986145,
        5110034315621294524,
        3309745253273453974,
    ]),
    fr([
        12152025428588442781,
        10017436759814941823,
        9425858230132234619,
        541159718738691305,
    ]),
    fr([
        4921517651709381729,
        7019755190471434522,
        5772467408839395114,
        3433403116595193766,
    ]),
    fr([
        4476954775899658055,
        16455725108873537707,
        17057243094356074342,
        1047161090952723745,
    ]),
    fr([
        16024218579227970290,
        17967272313006142771,
        2914245474723476585,
        1977645224100974366,
    ]),
    fr([
        13743978887778235958,
        12026548226003306677,
        5908934581865977881,
        2273623068421011000,
    ]),
    fr([
        15026148025623246938,
        7017365375651121320,
        13362203775692766459,
        3196855305397947311,
    ]),
    fr([
        7230795768364253136,
        5689669941378413668,
        2347922809012855059,
        1496674231358065592,
    ]),
    fr([
        1590208600321288204,
        1278500406467332564,
        2166443550355012015,
        1805155861746184086,
    ]),
    fr([
        11939997620247751826,
        1254162772588974346,
        12400438686983746541,
        2520197928408072530,
    ]),
    fr([
        17921885410191635235,
        6508386636717280494,
        11488439165356304983,
        3061458853693851659,
    ]),
    fr([
        5581610735822616978,
        5116163710525148053,
        14302018175288885244,
        3351107917329305281,
    ]),
    fr([
        3838795989580247311,
        10011342187661595175,
        5324038500973915796,
        1105569211509001899,
    ]),
    fr([
        4367615745282485450,
        18336655542467774180,
        15417577734611668508,
        1743155184994571594,
    ]),
    fr([
        15236160083837132606,
        9802680828863910649,
        1759829803479827694,
        2392791747812006571,
    ]),
    fr([
        10344642947593643441,
        13858095887687760552,
        18369013441839520176,
        1864368116261108815,
    ]),
    fr([
        7245172459533493547,
        8407955057861530292,
        10961314743364912429,
        1786981987808708487,
    ]),
    fr([
        16070361094095524749,
        7098580053720400890,
        5553788069046339386,
        2560455353844305179,
    ]),
    fr([
        10873505774808520000,
        7395666144235686685,
        16854991276585078248,
        2816754952741547200,
    ]),
    fr([
        17930403066157641249,
        15902826806284485605,
        6273972487180782888,
        3456060837292550653,
    ]),
    fr([
        7607466186621654296,
        16189685746723837782,
        6413961451630196898,
        1300512185651597801,
    ]),
    fr([
        11733677833812719509,
        2217061433775333917,
        8932982039038853895,
        2243354151561929136,
    ]),
    fr([
        10066004616493560530,
        12116626281459261078,
        5504397929972663843,
        2647712371439777249,
    ]),
    fr([
        8380201534932828781,
        6448859456605635368,
        14198981967304185037,
        1118694490103706769,
    ]),
    fr([
        4402877915756845551,
        5654966694911708340,
        3765360350956634457,
        655507305922402480,
    ]),
    fr([
        1334494499264290802,
        3325619209273891429,
        16674884815161413114,
        1999228915889446605,
    ]),
    fr([
        12433902338449926873,
        15375493165275486677,
        11635731754890122526,
        3416158187225972290,
    ]),
];
