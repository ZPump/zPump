# PTF Groth16 Circuit Suite

This workspace contains the reproducible proving pipeline for the Privacy Twin Factory (PTF)
Groth16 circuits.  The layout is intentionally simple so that the same scripts can be used by
local contributors, CI, or deterministic build runners.

> **Circom version**: 2.1.x • **SnarkJS version**: 0.7.x • **Curve**: BN254

## Directory layout

```
circuits/
  build/              # Generated artifacts (r1cs, wasm, zkeys, verification keys)
  inputs/             # Sample inputs used by smoke tests and documentation
  keys/               # Canonical verifying keys committed to git (see hashes.json)
  pot/                # Powers of Tau files (downloaded by `npm run setup:ptau`)
  scripts/            # Deterministic build & verification helpers
  shield/             # Shield circuit sources
  transfer/           # Private transfer circuit sources (v1.1 feature flag)
  unshield/           # Unshield circuit sources
```

Every circuit exports a single entry point that matches the v0.5 specification.  The circuits in
this repository are **reference implementations** – they focus on surfacing the public inputs and
on-curve commitments required by the on-chain programs.  They deliberately avoid fancy
optimisations so that auditors can follow the arithmetic.

## Installing dependencies

The circuits pipeline is a standalone NPM workspace.  From the `circuits/` directory run:

```bash
npm install
npm run setup:ptau         # downloads the 28th ceremony powers of tau if missing
```

Both commands are idempotent.  They cache the ceremony file under `pot/` and will skip downloads
when the expected hash already exists.

## Compiling circuits

```
npm run compile             # builds every circuit declared in scripts/circuits.json
npm run compile:shield      # builds only the shield circuit
npm run compile:unshield    # builds only the unshield circuit
npm run compile:transfer    # builds only the private transfer circuit
```

Each compile step performs the following deterministically:

1. `circom` compilation → `build/<name>/<name>.r1cs` + `.wasm` + `.sym`
2. Groth16 setup with `snarkjs groth16 setup`
3. Finalises the proving key via `snarkjs zkey beacon` using the fixed beacon from the spec
4. Exports a verifying key JSON and writes its SHA-256 hash to
   `build/<name>/verification_key.hash`
5. Copies the verifying key into `keys/<name>.json` so services can pin against it

All temporary files live under `build/` and can be removed with `npm run clean`.

## Sample proving run

The pipeline ships with smoke-test inputs that mirror the specification.  After compiling run:

```bash
npm run prove:shield
npm run prove:unshield
```

The scripts will execute `snarkjs groth16 prove` with the example witness data in `inputs/` and
store a proof bundle next to the circuit artifacts.  Proof outputs are written to
`build/<name>/proof.json` together with the public inputs so that the verifier program can be fed
without additional formatting.

## Deterministic beacons & hashing

- **Beacon**: `ptf-mvp-no-relayer` with round `1` and an all-zero entropy string.
- **Verification key hashing**: SHA-256 over the canonical JSON string emitted by `snarkjs`.
  The helper script `scripts/hash-verifying-key.js` performs this step and is reused by the
  Proof RPC service to assert that client-submitted hashes match the committed verifying keys.

## Adding new circuits

1. Create a folder named after the circuit (`circuits/<name>/circuit.circom`).
2. Append a record to `scripts/circuits.json` with the circuit metadata.
3. Provide at least one example input under `inputs/<name>.json`.
4. Re-run `npm run compile` and commit the generated verifying key file under `keys/`.

The build scripts intentionally **do not** commit `.zkey` files.  They are reproducible artefacts
that can be regenerated by anyone with the ceremony transcript.  Only the verifying keys and their
hashes are needed by on-chain programs and off-chain provers.

## Linting & formatting

`npm run lint` runs Prettier on `.circom`, `.json`, and script files to keep the workspace tidy.

---

If any part of the tooling drifts from the specification, update both this README and
`docs/solana-privacy-twin-factory-spec-v0.5.md` in tandem so downstream integrators stay in sync.
